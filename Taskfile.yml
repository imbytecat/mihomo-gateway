# https://taskfile.dev
version: "3"

vars:
  PACKER_BASE: packer
  GATEWAY_DIR: packer/mihomo-gateway

env:
  # See .env.example for all available variables

tasks:
  default:
    desc: Show available tasks
    cmds:
      - task --list

  # ============================================================
  # mihomo-gateway template
  # ============================================================
  gateway:init:
    desc: Initialize Packer plugins for mihomo-gateway
    dir: "{{.GATEWAY_DIR}}"
    cmds:
      - packer init .

  gateway:fmt:
    desc: Format Packer HCL files for mihomo-gateway
    dir: "{{.GATEWAY_DIR}}"
    cmds:
      - packer fmt .

  gateway:validate:
    desc: Validate mihomo-gateway template
    dir: "{{.GATEWAY_DIR}}"
    deps:
      - gateway:init
    cmds:
      - packer validate .

  gateway:build:
    desc: Build mihomo-gateway on Proxmox (requires API access)
    dir: "{{.GATEWAY_DIR}}"
    deps:
      - gateway:validate
    cmds:
      - packer build -only='proxmox-iso.mihomo-gateway' .

  gateway:build-local:
    desc: Build mihomo-gateway locally with QEMU (produces qcow2)
    dir: "{{.GATEWAY_DIR}}"
    deps:
      - gateway:validate
    cmds:
      - packer build -only='qemu.mihomo-gateway' .

  gateway:build-debug:
    desc: Build mihomo-gateway with debug output
    dir: "{{.GATEWAY_DIR}}"
    deps:
      - gateway:init
    env:
      PACKER_LOG: "1"
    cmds:
      - packer build -debug .

  gateway:download-mihomo:
    desc: Download latest Mihomo binary for offline builds
    dir: "{{.GATEWAY_DIR}}"
    cmds:
      - bash scripts/download-mihomo.sh

  # ============================================================
  # Generic packer commands (requires TEMPLATE variable)
  # Usage: task packer:build TEMPLATE=mihomo-gateway
  # ============================================================
  packer:init:
    desc: "Initialize Packer plugins (usage: task packer:init TEMPLATE=xxx)"
    dir: "{{.PACKER_BASE}}/{{.TEMPLATE}}"
    requires:
      vars: [TEMPLATE]
    cmds:
      - packer init .

  packer:validate:
    desc: "Validate template (usage: task packer:validate TEMPLATE=xxx)"
    dir: "{{.PACKER_BASE}}/{{.TEMPLATE}}"
    requires:
      vars: [TEMPLATE]
    deps:
      - task: packer:init
        vars: { TEMPLATE: "{{.TEMPLATE}}" }
    cmds:
      - packer validate .

  packer:build:
    desc: "Build template (usage: task packer:build TEMPLATE=xxx)"
    dir: "{{.PACKER_BASE}}/{{.TEMPLATE}}"
    requires:
      vars: [TEMPLATE]
    deps:
      - task: packer:validate
        vars: { TEMPLATE: "{{.TEMPLATE}}" }
    cmds:
      - packer build .

  # ============================================================
  # Utility tasks
  # ============================================================
  clean:
    desc: Clean all Packer caches and output directories
    cmds:
      - cmd: rm -rf packer_cache
        ignore_error: true
      - cmd: rm -rf {{.PACKER_BASE}}/*/packer_cache
        ignore_error: true
      - cmd: rm -rf {{.PACKER_BASE}}/*/output-*
        ignore_error: true

  list-templates:
    desc: List available Packer templates
    cmds:
      - cmd: ls -1 {{.PACKER_BASE}}/
        platforms: [linux, darwin]
      - cmd: dir /B {{.PACKER_BASE}}
        platforms: [windows]
